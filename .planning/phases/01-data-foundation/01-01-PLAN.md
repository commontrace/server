---
phase: 01-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - api/pyproject.toml
  - api/app/__init__.py
  - api/app/config.py
  - api/app/database.py
  - api/app/main.py
  - api/app/dependencies.py
  - api/app/models/__init__.py
  - api/app/models/base.py
  - api/app/models/trace.py
  - api/app/models/user.py
  - api/app/models/vote.py
  - api/app/models/tag.py
  - api/app/services/__init__.py
  - api/app/services/tags.py
  - mcp-server/pyproject.toml
  - skill/pyproject.toml
  - .python-version
autonomous: true

must_haves:
  truths:
    - "Trace model has title, context_text, solution_text, embedding, embedding_model_id, embedding_model_version, status, trust_score, confirmation_count, contributor_id, agent_model, agent_version, metadata_json, created_at, updated_at columns"
    - "User model has id, email, api_key_hash, display_name, reputation_score, is_seed, created_at, updated_at columns"
    - "Vote model has id, trace_id, voter_id, vote_type (up/down), feedback_text, context_json, created_at columns"
    - "Tag model has id, name (unique, indexed), is_curated columns; trace_tags join table has trace_id + tag_id composite PK"
    - "TraceStatus enum has pending and validated values"
    - "Tag normalize_tag function lowercases, trims, and truncates to 50 chars"
    - "Database engine uses postgresql+asyncpg with pgvector registered via event listener"
    - "Validation threshold is configurable via VALIDATION_THRESHOLD env var, not hardcoded"
  artifacts:
    - path: "pyproject.toml"
      provides: "uv workspace root declaring api, mcp-server, skill members"
      contains: "tool.uv.workspace"
    - path: "api/pyproject.toml"
      provides: "API package dependencies"
      contains: "commontrace-api"
    - path: "api/app/models/base.py"
      provides: "DeclarativeBase with naming convention and AsyncAttrs"
      contains: "NAMING_CONVENTION"
    - path: "api/app/models/trace.py"
      provides: "Trace ORM model with all columns"
      exports: ["Trace", "TraceStatus"]
    - path: "api/app/models/user.py"
      provides: "User ORM model"
      exports: ["User"]
    - path: "api/app/models/vote.py"
      provides: "Vote ORM model"
      exports: ["Vote", "VoteType"]
    - path: "api/app/models/tag.py"
      provides: "Tag model and trace_tags join table"
      exports: ["Tag", "trace_tags"]
    - path: "api/app/services/tags.py"
      provides: "Tag normalization function"
      exports: ["normalize_tag"]
    - path: "api/app/database.py"
      provides: "Async engine, session factory, pgvector registration"
      exports: ["engine", "async_session_factory", "get_db"]
    - path: "api/app/config.py"
      provides: "Pydantic BaseSettings with all env vars including VALIDATION_THRESHOLD"
      exports: ["settings"]
  key_links:
    - from: "api/app/models/trace.py"
      to: "api/app/models/base.py"
      via: "class Trace(Base)"
      pattern: "class Trace\\(Base\\)"
    - from: "api/app/models/trace.py"
      to: "api/app/models/user.py"
      via: "ForeignKey users.id"
      pattern: "ForeignKey.*users\\.id"
    - from: "api/app/models/tag.py"
      to: "api/app/models/trace.py"
      via: "secondary=trace_tags relationship"
      pattern: "secondary.*trace_tags"
    - from: "api/app/database.py"
      to: "api/app/config.py"
      via: "settings.database_url"
      pattern: "settings\\.database_url"
---

<objective>
Create the complete project skeleton, uv workspace, all SQLAlchemy 2.0 async ORM models, database wiring, and application config for CommonTrace.

Purpose: Every downstream plan (migrations, Docker, API endpoints, search) depends on stable ORM models and project structure existing first. This plan creates the foundation code that Alembic autogenerate reads, that Docker services run, and that API endpoints import.

Output: Working Python project with all ORM models importable, database engine configured, and uv workspace ready for `uv sync`.
</objective>

<execution_context>
@/home/bitnami/.claude/get-shit-done/workflows/execute-plan.md
@/home/bitnami/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-data-foundation/01-CONTEXT.md
@.planning/phases/01-data-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project skeleton and uv workspace</name>
  <files>
    pyproject.toml
    .python-version
    api/pyproject.toml
    api/app/__init__.py
    api/app/config.py
    api/app/database.py
    api/app/main.py
    api/app/dependencies.py
    api/app/models/__init__.py
    api/app/services/__init__.py
    mcp-server/pyproject.toml
    skill/pyproject.toml
  </files>
  <action>
Create the uv workspace monorepo structure. All files created from scratch (greenfield project).

1. **Root `pyproject.toml`**: Workspace root with `[tool.uv.workspace]` declaring `members = ["api", "mcp-server", "skill"]`. Set `requires-python = ">=3.12"`. Add `[tool.ruff]` config (line-length=120, target-version="py312").

2. **`.python-version`**: Contains `3.12` (for uv to use).

3. **`api/pyproject.toml`**: Package name `commontrace-api`, version `0.1.0`. Dependencies:
   - `fastapi>=0.129.0`
   - `uvicorn[standard]>=0.30.0`
   - `sqlalchemy[asyncio]>=2.0.46`
   - `asyncpg>=0.31.0`
   - `alembic>=1.18.0`
   - `pgvector>=0.4.2`
   - `pydantic>=2.12.0`
   - `pydantic-settings>=2.0.0`
   - `python-dotenv`
   - `structlog`
   Dev dependencies: `pytest`, `pytest-asyncio`, `httpx`, `factory-boy`, `ruff`, `mypy`.

4. **`mcp-server/pyproject.toml`**: Skeleton package `commontrace-mcp`, version `0.1.0`, minimal — just `requires-python = ">=3.12"`, no dependencies yet (Phase 5).

5. **`skill/pyproject.toml`**: Skeleton package `commontrace-skill`, version `0.1.0`, minimal — just `requires-python = ">=3.12"`, no dependencies yet (Phase 6).

6. **`api/app/__init__.py`**: Empty file.

7. **`api/app/config.py`**: Pydantic `BaseSettings` class named `Settings` using `model_config = SettingsConfigDict(env_file=".env", env_file_encoding="utf-8")`. Fields:
   - `database_url: str` (default: `"postgresql+asyncpg://commontrace:commontrace@localhost:5432/commontrace"`)
   - `redis_url: str` (default: `"redis://localhost:6379"`)
   - `validation_threshold: int` (default: `2`) — per user decision: configurable, not hardcoded
   - `app_name: str` (default: `"CommonTrace"`)
   - `debug: bool` (default: `False`)
   - `embedding_dimensions: int` (default: `1536`) — matches text-embedding-3-small
   Export a module-level `settings = Settings()` instance.

8. **`api/app/database.py`**:
   - Create `engine = create_async_engine(settings.database_url, echo=settings.debug)`
   - Register pgvector with asyncpg via `@event.listens_for(engine.sync_engine, "connect")` calling `dbapi_connection.run_async(register_vector)` (per research Pattern 3)
   - Create `async_session_factory = async_sessionmaker(engine, expire_on_commit=False, class_=AsyncSession)`
   - Export `get_db()` async generator for FastAPI dependency injection

9. **`api/app/main.py`**: Minimal FastAPI app factory. Create `app = FastAPI(title="CommonTrace API", version="0.1.0")` with a health check endpoint `GET /health` returning `{"status": "ok"}`. Do NOT run Alembic migrations at startup (research anti-pattern).

10. **`api/app/dependencies.py`**: Re-export `get_db` from database.py for clean import paths. Add type alias `DbSession = Annotated[AsyncSession, Depends(get_db)]`.

11. **`api/app/models/__init__.py`**: Import and re-export all models: `from .base import Base`, `from .trace import Trace, TraceStatus`, `from .user import User`, `from .vote import Vote, VoteType`, `from .tag import Tag, trace_tags`. This ensures Alembic autogenerate sees all models.

12. **`api/app/services/__init__.py`**: Empty file.

After creating all files, run `cd /home/bitnami/commontrace && uv sync` to install dependencies and verify the workspace resolves.
  </action>
  <verify>
Run `cd /home/bitnami/commontrace && uv sync` completes without errors. Run `cd /home/bitnami/commontrace && uv run --package commontrace-api python -c "from app.config import settings; print(settings.database_url)"` prints the default database URL.
  </verify>
  <done>uv workspace resolves, all three sub-packages recognized, api dependencies installed, config importable with correct defaults including validation_threshold=2.</done>
</task>

<task type="auto">
  <name>Task 2: SQLAlchemy ORM models for all tables</name>
  <files>
    api/app/models/base.py
    api/app/models/trace.py
    api/app/models/user.py
    api/app/models/vote.py
    api/app/models/tag.py
  </files>
  <action>
Create all ORM models following SQLAlchemy 2.0 patterns from research (Pattern 2: DeclarativeBase with naming convention + AsyncAttrs, Mapped[] type hints, mapped_column).

1. **`api/app/models/base.py`**:
   - Define `NAMING_CONVENTION` dict with ix, uq, ck, fk, pk patterns (exactly as in research Pattern 2)
   - `class Base(AsyncAttrs, DeclarativeBase)` with `metadata = MetaData(naming_convention=NAMING_CONVENTION)`
   - This naming convention is REQUIRED for Alembic autogenerate to detect constraint changes

2. **`api/app/models/user.py`** — `users` table:
   - `id`: UUID primary key, default uuid4
   - `email`: String(255), unique, nullable (nullable because Phase 2 adds registration requirement — for now allow API-key-only users)
   - `api_key_hash`: String(255), nullable, unique — hashed API key
   - `display_name`: String(100), nullable
   - `reputation_score`: Float, default 0.0, not null
   - `is_seed`: Boolean, default False — marks seed/curated data users
   - `created_at`: DateTime(timezone=True), server_default=func.now()
   - `updated_at`: DateTime(timezone=True), server_default=func.now(), onupdate=func.now()
   - Relationships: `traces` (back_populates="contributor"), `votes` (back_populates="voter")

3. **`api/app/models/trace.py`** — `traces` table:
   - `TraceStatus(str, enum.Enum)`: `pending = "pending"`, `validated = "validated"` (two-tier per user decision)
   - `id`: UUID primary key, default uuid4
   - `title`: Text, not null (required per user decision — short summary like SO question title)
   - `context_text`: Text, not null (free-form markdown per user decision)
   - `solution_text`: Text, not null (free-form markdown per user decision)
   - `embedding`: Vector(1536), nullable=True (null until background worker processes — dimension from config discretion, 1536 for text-embedding-3-small)
   - `embedding_model_id`: String(100), nullable=True (per DATA-02 — must exist from day one)
   - `embedding_model_version`: String(100), nullable=True (per DATA-02 — must exist from day one)
   - `status`: String(20), default=TraceStatus.pending, not null (per DATA-04 — every trace starts pending)
   - `trust_score`: Float, default=0.0, not null
   - `confirmation_count`: Integer, default=0, not null (tracks confirmations toward validation threshold)
   - `contributor_id`: UUID, ForeignKey("users.id"), not null
   - `agent_model`: String(100), nullable=True (domain-agnostic per user decision)
   - `agent_version`: String(50), nullable=True (domain-agnostic per user decision)
   - `metadata_json`: JSON, nullable=True (open-ended extras — domain-agnostic per user decision)
   - `is_seed`: Boolean, default=False — marks seed/curated traces (auto-validated on import per user decision)
   - `created_at`: DateTime(timezone=True), server_default=func.now()
   - `updated_at`: DateTime(timezone=True), server_default=func.now(), onupdate=func.now()
   - Relationships: `contributor` (User, back_populates="traces"), `votes` (Vote list), `tags` (Tag list via secondary="trace_tags")

4. **`api/app/models/vote.py`** — `votes` table:
   - `VoteType(str, enum.Enum)`: `up = "up"`, `down = "down"`
   - `id`: UUID primary key, default uuid4
   - `trace_id`: UUID, ForeignKey("traces.id"), not null
   - `voter_id`: UUID, ForeignKey("users.id"), not null
   - `vote_type`: String(10), not null (up or down)
   - `feedback_text`: Text, nullable (contextual feedback — why it worked/didn't)
   - `context_json`: JSON, nullable (environment metadata: language version, framework version, OS — enables future context-aware scoring)
   - `created_at`: DateTime(timezone=True), server_default=func.now()
   - Relationships: `trace` (Trace, back_populates="votes"), `voter` (User, back_populates="votes")
   - Add UniqueConstraint on (trace_id, voter_id) — one vote per user per trace

5. **`api/app/models/tag.py`** — `tags` table + `trace_tags` join table:
   - `trace_tags = Table(...)` with composite PK (trace_id UUID FK, tag_id UUID FK) — per research Pattern
   - `Tag` class:
     - `id`: UUID primary key, default uuid4
     - `name`: String(50), unique, not null, indexed — normalized tag name
     - `is_curated`: Boolean, default=False — distinguishes core controlled tags from free-form (per user decision: hybrid model)
     - `created_at`: DateTime(timezone=True), server_default=func.now()
   - Relationship: `traces` (Trace list via secondary="trace_tags")

Use `from sqlalchemy.dialects.postgresql import UUID, JSON` for PostgreSQL-specific types. Use `Mapped[]` type annotations with `mapped_column()` throughout. Import `Vector` from `pgvector.sqlalchemy`.

Do NOT use SQLAlchemy Enum type for status/vote_type columns — use String columns with Python enums for defaults. This avoids PostgreSQL enum type management in migrations.
  </action>
  <verify>
Run `cd /home/bitnami/commontrace && uv run --package commontrace-api python -c "from app.models import Base, Trace, User, Vote, Tag, trace_tags, TraceStatus; print('Tables:', list(Base.metadata.tables.keys())); print('TraceStatus:', list(TraceStatus))"` — should print all 5 table names (users, traces, votes, tags, trace_tags) and TraceStatus enum values.
  </verify>
  <done>All five tables defined in ORM models (users, traces, votes, tags, trace_tags). Trace has embedding_model_id + embedding_model_version (DATA-02). Trace defaults to pending status (DATA-04). Tag has is_curated flag (hybrid model). Vote has unique constraint on trace_id+voter_id. All models importable from app.models.</done>
</task>

<task type="auto">
  <name>Task 3: Tag normalization service</name>
  <files>
    api/app/services/tags.py
  </files>
  <action>
Create a pure Python tag normalization function in the service layer (NOT in database triggers — per research anti-pattern guidance).

**`api/app/services/tags.py`**:

1. `normalize_tag(raw: str) -> str`: Strip whitespace, lowercase, truncate to 50 chars. Return the canonical form. This is the single point of tag normalization — all code paths that create or look up tags MUST call this function first.

2. `normalize_tags(raw_tags: list[str]) -> list[str]`: Apply normalize_tag to each, then deduplicate (preserving order). Return unique normalized tags. This handles the "deduplicated" requirement from user decisions.

3. `validate_tag(normalized: str) -> bool`: Check that a normalized tag is valid — non-empty after normalization, contains only alphanumeric chars, hyphens, dots, and underscores (no spaces, no special characters). Return True/False.

Keep this module pure (no database imports, no async) so it can be unit tested without a database.
  </action>
  <verify>
Run `cd /home/bitnami/commontrace && uv run --package commontrace-api python -c "
from app.services.tags import normalize_tag, normalize_tags, validate_tag
assert normalize_tag('  Python  ') == 'python'
assert normalize_tag('FastAPI') == 'fastapi'
assert normalize_tag('a' * 100) == 'a' * 50
assert normalize_tags(['Python', 'python', 'PYTHON', 'fastapi']) == ['python', 'fastapi']
assert validate_tag('python') == True
assert validate_tag('') == False
print('All tag normalization assertions passed')
"` — all assertions pass.
  </verify>
  <done>Tag normalization function exists in service layer, lowercases, trims, truncates to 50 chars, deduplicates lists, validates format. Pure Python, no DB dependency, testable in isolation. Satisfies DATA-03 normalization requirement.</done>
</task>

</tasks>

<verification>
1. `uv sync` succeeds from repo root with all three workspace members recognized
2. All ORM models importable: `from app.models import Base, Trace, User, Vote, Tag, TraceStatus, VoteType, trace_tags`
3. `Base.metadata.tables` contains exactly: users, traces, votes, tags, trace_tags
4. Trace model has embedding_model_id and embedding_model_version columns (DATA-02)
5. TraceStatus enum has pending and validated values (DATA-04)
6. Tag model has is_curated boolean (hybrid tag taxonomy)
7. Vote has UniqueConstraint on (trace_id, voter_id)
8. Tag normalization: `normalize_tag("  Python  ") == "python"` (DATA-03)
9. Settings has validation_threshold with default 2 (configurable per user decision)
</verification>

<success_criteria>
- Project imports cleanly with `uv run --package commontrace-api python -c "from app.models import *"`
- All 5 tables registered in Base.metadata
- Tag normalization handles mixed case, whitespace, duplicates, and length
- Config loads validation_threshold from env with default=2
- mcp-server/ and skill/ skeleton packages exist in workspace
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-01-SUMMARY.md`
</output>
