---
phase: 04-reputation-engine
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - api/app/models/reputation.py
  - api/app/models/__init__.py
  - api/app/services/trust.py
  - api/app/dependencies.py
  - api/app/schemas/reputation.py
  - api/migrations/versions/0003_domain_reputation.py
  - api/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Wilson score lower bound returns 0.0 for zero votes and a value in (0,1) for positive vote counts"
    - "Wilson score for 1 upvote / 1 total is significantly lower than Wilson score for 50 upvotes / 55 total — sample size matters"
    - "RequireEmail dependency raises 403 when user.email is None"
    - "RequireEmail dependency passes through the user when user.email is set"
    - "ContributorDomainReputation table exists with unique constraint on (contributor_id, domain_tag)"
  artifacts:
    - path: "api/app/services/trust.py"
      provides: "Wilson score lower bound function"
      contains: "wilson_score_lower_bound"
    - path: "api/app/models/reputation.py"
      provides: "ContributorDomainReputation ORM model"
      contains: "class ContributorDomainReputation"
    - path: "api/app/dependencies.py"
      provides: "RequireEmail dependency alias"
      contains: "RequireEmail"
    - path: "api/app/schemas/reputation.py"
      provides: "ReputationResponse and DomainReputationItem schemas"
      exports: ["ReputationResponse", "DomainReputationItem"]
    - path: "api/migrations/versions/0003_domain_reputation.py"
      provides: "Alembic migration for contributor_domain_reputation table"
      contains: "contributor_domain_reputation"
  key_links:
    - from: "api/app/services/trust.py"
      to: "api/app/models/reputation.py"
      via: "wilson_score_lower_bound used for ContributorDomainReputation.wilson_score computation"
      pattern: "wilson_score_lower_bound"
    - from: "api/app/models/__init__.py"
      to: "api/app/models/reputation.py"
      via: "import and re-export ContributorDomainReputation"
      pattern: "ContributorDomainReputation"
---

<objective>
Add the Wilson score computation engine, ContributorDomainReputation ORM model and migration, RequireEmail identity gate, and reputation Pydantic schemas.

Purpose: Establish the foundation artifacts (model, migration, formula, dependency, schemas) that Plan 04-02 will wire into the vote flow and expose via a read endpoint. Wilson score is a pure TDD candidate — defined input/output contract, no UI, pure arithmetic.

Output: wilson_score_lower_bound() function in trust.py (tested via TDD), ContributorDomainReputation model with migration 0003, RequireEmail dependency in dependencies.py, reputation schemas in schemas/reputation.py, email-validator package installed.
</objective>

<execution_context>
@/home/bitnami/.claude/get-shit-done/workflows/execute-plan.md
@/home/bitnami/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-reputation-engine/04-RESEARCH.md
@api/app/services/trust.py
@api/app/models/user.py
@api/app/models/__init__.py
@api/app/dependencies.py
@api/migrations/versions/0002_amendments_and_staleness.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wilson score function (TDD) + ContributorDomainReputation model + migration + RequireEmail + schemas</name>
  <files>
    api/app/services/trust.py
    api/app/models/reputation.py
    api/app/models/__init__.py
    api/app/dependencies.py
    api/app/schemas/reputation.py
    api/migrations/versions/0003_domain_reputation.py
    api/pyproject.toml
  </files>
  <action>
**RED phase — Write failing tests first:**

Create `api/tests/test_wilson_score.py` with tests for `wilson_score_lower_bound(upvotes, total_votes)`:
- `wilson_score_lower_bound(0, 0)` returns `0.0` (no data = no confidence)
- `wilson_score_lower_bound(1, 1)` returns a value > 0 and < 1.0 (single upvote has wide confidence interval)
- `wilson_score_lower_bound(50, 55)` returns a value higher than `wilson_score_lower_bound(1, 1)` (sample size matters — the REPU-01 success criterion)
- `wilson_score_lower_bound(0, 10)` returns `0.0` (no upvotes = zero lower bound)
- `wilson_score_lower_bound(10, 10)` returns a value close to but less than 1.0 (perfect but small sample)
- Return type is always float

Run tests — they MUST fail (function does not exist yet). Commit: `test(04-01): add failing Wilson score tests`

**GREEN phase — Implement wilson_score_lower_bound:**

Add to `api/app/services/trust.py` (ABOVE the existing `apply_vote_to_trace` function):

```python
import math

def wilson_score_lower_bound(upvotes: int, total_votes: int) -> float:
    """Compute the 95% Wilson score confidence interval lower bound.

    Returns 0.0 when total_votes == 0 (no data = no confidence).
    Returns a value in [0, 1] representing the lower bound of the true
    positive rate at 95% confidence.

    BASE_WEIGHT context: new contributors with no votes score 0.0.
    An established contributor with 80% upvote rate on 50 votes scores ~0.66.
    This creates a measurable weight difference for REPU-01.

    Source: https://www.evanmiller.org/how-not-to-sort-by-average-rating.html

    Args:
        upvotes: Number of positive votes.
        total_votes: Total votes (upvotes + downvotes).

    Returns:
        Wilson score lower bound in [0, 1].
    """
    if total_votes == 0:
        return 0.0
    z = 1.9600  # 95% confidence z-score
    z2 = z * z   # 3.8416
    p_hat = upvotes / total_votes
    n = total_votes
    numerator = p_hat + z2 / (2 * n) - z * math.sqrt(
        (p_hat * (1 - p_hat) + z2 / (4 * n)) / n
    )
    return numerator / (1 + z2 / n)
```

Add `import math` at the top of trust.py. Run tests — they MUST pass. Commit: `feat(04-01): implement Wilson score lower bound`

**Then implement the remaining artifacts (non-TDD, standard execution):**

1. **Install email-validator:** Run `cd api && uv add "email-validator>=2.3.0"` to add the Pydantic email validation dependency.

2. **Create `api/app/models/reputation.py`** — ContributorDomainReputation ORM model:
   - Fields: `id` (UUID PK), `contributor_id` (UUID FK to users.id), `domain_tag` (String(50)), `upvote_count` (Integer default=0), `downvote_count` (Integer default=0), `wilson_score` (Float default=0.0), `updated_at` (DateTime(timezone=True) with server_default=func.now(), onupdate=func.now())
   - UniqueConstraint on `(contributor_id, domain_tag)` named `"uq_contributor_domain_reputation_contributor_domain"`
   - Index on `contributor_id`
   - `contributor` relationship to User with `lazy="raise"` (never implicitly loaded in async context)
   - Use `TYPE_CHECKING` import for User type hint
   - Define module-level constant: `CDR_UNIQUE_CONSTRAINT = "uq_contributor_domain_reputation_contributor_domain"` for use in upsert code (Pattern 4 from research — pitfall 4)

3. **Update `api/app/models/__init__.py`** — add import and re-export of `ContributorDomainReputation` from `.reputation`

4. **Create `api/migrations/versions/0003_domain_reputation.py`** — manual migration (consistent with project policy):
   - `revision = "d4e5f6a7b8c9"`, `down_revision = "c3d4e5f6a7b8"` (chains after 0002)
   - Creates `contributor_domain_reputation` table with all columns matching the ORM model
   - `server_default="0"` for upvote_count and downvote_count, `server_default="0.0"` for wilson_score
   - `server_default=sa.text("now()")` for updated_at
   - UniqueConstraint named `"uq_contributor_domain_reputation_contributor_domain"`
   - Creates indexes: `ix_cdr_contributor_id` on `contributor_id`, `ix_cdr_domain_tag` on `domain_tag`
   - downgrade drops indexes then table in reverse order

5. **Add RequireEmail to `api/app/dependencies.py`:**
   ```python
   from typing import Annotated

   async def require_email(user: User = Depends(get_current_user)) -> User:
       """Gate: requires authenticated user to have a registered email.

       Raises 403 if user.email is None. Implements identity cost (REPU-02):
       anonymous API key usage cannot submit contributions.
       Applied to write paths only — NOT to POST /api/v1/keys or GET endpoints.
       """
       if user.email is None:
           raise HTTPException(
               status_code=403,
               detail="Email registration required to submit contributions. "
                      "Re-register with POST /api/v1/keys providing an email address.",
           )
       return user

   RequireEmail = Annotated[User, Depends(require_email)]
   ```
   Note: `Annotated` is already imported via the existing `from typing import Annotated` (check first; add if missing). Place after the existing `CurrentUser` alias.

6. **Create `api/app/schemas/reputation.py`:**
   ```python
   import uuid
   from pydantic import BaseModel, ConfigDict

   class DomainReputationItem(BaseModel):
       domain_tag: str
       wilson_score: float
       upvote_count: int
       downvote_count: int

   class ReputationResponse(BaseModel):
       model_config = ConfigDict(from_attributes=True)
       user_id: uuid.UUID
       overall_wilson_score: float
       domains: list[DomainReputationItem]
   ```

Commit all non-TDD artifacts: `feat(04-01): add domain reputation model, migration, RequireEmail, schemas`
  </action>
  <verify>
1. Run `cd /home/bitnami/commontrace/api && python -m pytest tests/test_wilson_score.py -v` — all Wilson score tests pass
2. Run `python -c "from app.models.reputation import ContributorDomainReputation; print(ContributorDomainReputation.__tablename__)"` — prints `contributor_domain_reputation`
3. Run `python -c "from app.dependencies import RequireEmail; print(RequireEmail)"` — prints the Annotated type
4. Run `python -c "from app.schemas.reputation import ReputationResponse, DomainReputationItem; print('OK')"` — prints OK
5. Run `python -c "from app.services.trust import wilson_score_lower_bound; print(wilson_score_lower_bound(50, 55))"` — prints a float ~0.82
6. Verify migration file exists: `ls api/migrations/versions/0003_domain_reputation.py`
  </verify>
  <done>
Wilson score function passes all TDD tests (zero-vote guard, sample-size ordering, return type). ContributorDomainReputation model exists with unique constraint on (contributor_id, domain_tag). Migration 0003 chains after 0002. RequireEmail dependency raises 403 for users without email. ReputationResponse and DomainReputationItem schemas importable. email-validator installed.
  </done>
</task>

</tasks>

<verification>
- `wilson_score_lower_bound(0, 0)` returns `0.0` (no divide-by-zero)
- `wilson_score_lower_bound(50, 55)` > `wilson_score_lower_bound(1, 1)` (sample size creates measurable difference per REPU-01)
- Migration 0003 chains correctly from 0002 (`down_revision = "c3d4e5f6a7b8"`)
- RequireEmail is a FastAPI dependency that can be used as a type annotation in endpoint signatures
- All imports resolve without circular dependency errors
</verification>

<success_criteria>
- Wilson score formula is implemented, tested via TDD (RED/GREEN commits), and returns correct values for edge cases
- ContributorDomainReputation ORM model + migration 0003 exist and are consistent
- RequireEmail dependency is ready to be applied to write endpoints in Plan 04-02
- Reputation Pydantic schemas are ready for the read endpoint in Plan 04-02
</success_criteria>

<output>
After completion, create `.planning/phases/04-reputation-engine/04-01-SUMMARY.md`
</output>
