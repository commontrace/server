---
phase: 08-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp-server/app/server.py
  - mcp-server/app/formatters.py
  - mcp-server/pyproject.toml
  - mcp-server/app/backend_client.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "An MCP-compatible agent can call amend_trace with trace_id, improved_solution, and explanation and receive a confirmation string with the amendment ID"
    - "httpx is declared as an explicit dependency in mcp-server/pyproject.toml"
    - "The unawaited coroutine RuntimeWarning when circuit breaker is open no longer occurs"
  artifacts:
    - path: "mcp-server/app/server.py"
      provides: "amend_trace MCP tool definition"
      contains: "async def amend_trace"
    - path: "mcp-server/app/formatters.py"
      provides: "format_amendment_result formatter"
      contains: "def format_amendment_result"
    - path: "mcp-server/pyproject.toml"
      provides: "Explicit httpx dependency"
      contains: "httpx"
    - path: "mcp-server/app/backend_client.py"
      provides: "Fixed circuit breaker that awaits coroutines before discarding"
      contains: "await"
  key_links:
    - from: "mcp-server/app/server.py"
      to: "/api/v1/traces/{id}/amendments"
      via: "backend.post call in amend_trace tool"
      pattern: "backend\\.post.*amendments"
    - from: "mcp-server/app/server.py"
      to: "mcp-server/app/formatters.py"
      via: "import format_amendment_result"
      pattern: "format_amendment_result"
---

<objective>
Close three MCP-server tech debt items from the v1.0 milestone audit: add the missing amend_trace MCP tool so agents can submit amendments through the MCP protocol, declare httpx as an explicit dependency instead of relying on transitive availability through fastmcp, and fix the unawaited coroutine warning when the circuit breaker is open.

Purpose: Complete MCP tool coverage (6 tools matching all 6 API write/read operations) and harden the dependency chain.
Output: Updated server.py with amend_trace tool, updated formatters.py with format_amendment_result, updated pyproject.toml with httpx, updated backend_client.py with coroutine cleanup.
</objective>

<execution_context>
@/home/bitnami/.claude/get-shit-done/workflows/execute-plan.md
@/home/bitnami/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/v1.0-MILESTONE-AUDIT.md

@mcp-server/app/server.py
@mcp-server/app/formatters.py
@mcp-server/app/backend_client.py
@mcp-server/pyproject.toml
@api/app/routers/amendments.py
@api/app/schemas/amendment.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add amend_trace MCP tool with formatter and httpx dependency</name>
  <files>
    mcp-server/app/formatters.py
    mcp-server/app/server.py
    mcp-server/pyproject.toml
  </files>
  <action>
1. In `mcp-server/app/formatters.py`, add a `format_amendment_result` function following the exact pattern of `format_contribution_result`:

```python
def format_amendment_result(data: dict) -> str:
    """Format POST /traces/{id}/amendments response into a readable string."""
    amendment_id = data.get("id", "unknown")
    trace_id = data.get("original_trace_id", "unknown")
    return (
        f"Amendment submitted successfully (ID: {amendment_id}). "
        f"Linked to trace {trace_id} — it will be reviewed by the community."
    )
```

2. In `mcp-server/app/server.py`:
   - Add `format_amendment_result` to the imports from `app.formatters`
   - Update the module docstring to say "six MCP tools" instead of "five" and add the amend_trace line to the tool list
   - Update the `mcp` FastMCP instructions string to mention amend_trace: "Use amend_trace to propose an improved solution to an existing trace."
   - Add the `amend_trace` tool following the exact pattern of `vote_trace` (write operation, 2s SLA timeout, same error handling):

```python
@mcp.tool(annotations={"readOnlyHint": False})
async def amend_trace(
    trace_id: str,
    improved_solution: str,
    explanation: str,
    headers: dict = Depends(CurrentHeaders()),
) -> str:
    """Submit an amendment to an existing trace with an improved solution.

    Args:
        trace_id: UUID of the trace to amend
        improved_solution: The improved solution text
        explanation: Why this amendment is better than the original
    """
    api_key = _extract_api_key(headers)

    try:
        result = await backend.post(
            f"/api/v1/traces/{trace_id}/amendments",
            json={
                "improved_solution": improved_solution,
                "explanation": explanation,
            },
            api_key=api_key,
            timeout=settings.write_timeout,
        )
        return format_amendment_result(result)
    except CircuitOpenError:
        return (
            "[CommonTrace unavailable] The knowledge base is temporarily unreachable. "
            "Your amendment could not be submitted. Please try again later."
        )
    except BackendUnavailableError:
        return (
            "[CommonTrace timeout] The submission took too long and was cancelled. "
            "The knowledge base may be under heavy load. Please try again later."
        )
    except httpx.HTTPStatusError as exc:
        detail = "Unknown error"
        try:
            detail = exc.response.json().get("detail", str(exc))
        except Exception:
            detail = str(exc)
        return format_error(exc.response.status_code, detail)
    except Exception as exc:
        return f"[CommonTrace error] Unexpected error: {exc}. Your amendment was not recorded."
```

3. In `mcp-server/pyproject.toml`, add `"httpx>=0.27"` to the dependencies list. This makes the httpx dependency explicit instead of relying on transitive availability through fastmcp.
  </action>
  <verify>
Run: `cd /home/bitnami/commontrace/mcp-server && python -c "from app.formatters import format_amendment_result; print(format_amendment_result({'id': 'abc', 'original_trace_id': 'def'}))"` — should print confirmation string.
Run: `cd /home/bitnami/commontrace/mcp-server && python -c "from app.server import mcp; tools = [t.name for t in mcp._tool_manager._tools.values()]; print(tools); assert 'amend_trace' in tools; assert len(tools) == 6"` — should list 6 tools including amend_trace.
Run: `grep 'httpx' /home/bitnami/commontrace/mcp-server/pyproject.toml` — should show httpx as explicit dependency.
  </verify>
  <done>amend_trace MCP tool exists and is callable, format_amendment_result produces readable output, httpx is an explicit dependency in pyproject.toml</done>
</task>

<task type="auto">
  <name>Task 2: Fix unawaited coroutine warning in circuit breaker</name>
  <files>mcp-server/app/backend_client.py</files>
  <action>
The bug: In `BackendClient.post()` and `BackendClient.get()`, the inner `_request()` async function is called as `_request()` which creates a coroutine object. This coroutine is passed to `self.breaker.call()`. When the circuit breaker is OPEN, it raises `CircuitOpenError` immediately without ever awaiting the coroutine — causing a "coroutine was never awaited" RuntimeWarning.

Fix: Change the circuit breaker `call()` method to accept a coroutine factory (callable) instead of a pre-created coroutine. This way the coroutine is only created when it will actually be awaited.

In `mcp-server/app/backend_client.py`, update the `CircuitBreaker.call()` method:

```python
async def call(self, coro_factory, timeout: float):
    """Execute coroutine factory with circuit breaker protection and timeout.

    Args:
        coro_factory: A zero-argument callable that returns a coroutine.
        timeout: Per-request SLA timeout in seconds.
    """
    if self.state == "open":
        if time.monotonic() - self.last_failure_time > self.recovery_timeout:
            self.state = "half-open"
        else:
            raise CircuitOpenError(
                "CommonTrace backend is temporarily unavailable. "
                "Please try again in a few seconds."
            )

    try:
        result = await asyncio.wait_for(coro_factory(), timeout=timeout)
        self._on_success()
        return result
    except (httpx.HTTPError, asyncio.TimeoutError, ConnectionError, OSError) as exc:
        self._on_failure()
        raise BackendUnavailableError(str(exc)) from exc
```

Then update the call sites in `BackendClient.post()` and `BackendClient.get()` to pass the factory instead of the coroutine:

In `post()`: change `await self.breaker.call(_request(), timeout=timeout)` to `await self.breaker.call(_request, timeout=timeout)` (remove the parentheses — pass the function, not its result).

In `get()`: same change — `await self.breaker.call(_request, timeout=timeout)` (remove parentheses).

This ensures the coroutine is never created when the circuit is open, eliminating the RuntimeWarning.
  </action>
  <verify>
Run: `cd /home/bitnami/commontrace/mcp-server && python -c "
import asyncio
from app.backend_client import CircuitBreaker, CircuitOpenError

async def test():
    cb = CircuitBreaker(failure_threshold=1, recovery_timeout=999)
    cb.state = 'open'
    cb.last_failure_time = __import__('time').monotonic()
    try:
        await cb.call(lambda: asyncio.sleep(0), timeout=1.0)
    except CircuitOpenError:
        print('CircuitOpenError raised without coroutine warning')

asyncio.run(test())
"` — should print success message with no RuntimeWarning.
Run: `cd /home/bitnami/commontrace/mcp-server && python -W error::RuntimeWarning -c "
import asyncio
from app.backend_client import CircuitBreaker, CircuitOpenError

async def test():
    cb = CircuitBreaker(failure_threshold=1, recovery_timeout=999)
    cb.state = 'open'
    cb.last_failure_time = __import__('time').monotonic()
    try:
        await cb.call(lambda: asyncio.sleep(0), timeout=1.0)
    except CircuitOpenError:
        pass
    print('No RuntimeWarning raised')

asyncio.run(test())
"` — should complete without error (RuntimeWarnings would be promoted to exceptions by -W error).
  </verify>
  <done>Circuit breaker open state no longer creates unawaited coroutines; -W error::RuntimeWarning test passes cleanly</done>
</task>

</tasks>

<verification>
1. `amend_trace` is registered as an MCP tool and callable with trace_id, improved_solution, explanation parameters
2. `format_amendment_result` returns a human-readable confirmation string
3. `httpx` appears as an explicit dependency line in mcp-server/pyproject.toml
4. Circuit breaker open state produces no RuntimeWarning when tested with -W error::RuntimeWarning
5. All existing MCP tools (search_traces, contribute_trace, vote_trace, get_trace, list_tags) still importable
</verification>

<success_criteria>
- 6 MCP tools registered (was 5) including amend_trace
- httpx is explicit in pyproject.toml dependencies
- No unawaited coroutine warning from circuit breaker open state
- All existing tools unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-tech-debt-cleanup/08-01-SUMMARY.md`
</output>
