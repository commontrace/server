---
phase: 08-tech-debt-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/app/services/tags.py
  - api/migrations/env.py
  - api/app/routers/traces.py
  - docker-compose.yml
  - .env.example
  - README.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "normalize_tags (plural) function no longer exists in tags.py — only normalize_tag (singular) and validate_tag remain"
    - "migrations/env.py imports Amendment and ContributorDomainReputation models so Alembic autogenerate can detect schema drift"
    - "traces.py docstring accurately describes RequireEmail dependency, not CurrentUser"
    - "Docker Compose api service has a healthcheck and mcp-server depends on it with service_healthy condition"
    - "README.md documents OPENAI_API_KEY and COMMONTRACE_API_KEY with degraded behavior explanation"
    - ".env.example includes OPENAI_API_KEY and COMMONTRACE_API_KEY with comments"
  artifacts:
    - path: "api/app/services/tags.py"
      provides: "Tag normalization without dead code"
      contains: "normalize_tag"
    - path: "api/migrations/env.py"
      provides: "Complete model imports for Alembic"
      contains: "Amendment"
    - path: "docker-compose.yml"
      provides: "API healthcheck and service_healthy dependency"
      contains: "service_healthy"
    - path: "README.md"
      provides: "Configuration documentation"
      contains: "OPENAI_API_KEY"
    - path: ".env.example"
      provides: "Environment variable template with all required keys"
      contains: "COMMONTRACE_API_KEY"
  key_links:
    - from: "docker-compose.yml"
      to: "api service /health endpoint"
      via: "healthcheck curl command"
      pattern: "healthcheck"
    - from: "docker-compose.yml"
      to: "mcp-server depends_on"
      via: "service_healthy condition"
      pattern: "service_healthy"
    - from: "api/migrations/env.py"
      to: "api/app/models/amendment.py"
      via: "import Amendment"
      pattern: "from app\\.models\\.amendment import Amendment"
    - from: "api/migrations/env.py"
      to: "api/app/models/reputation.py"
      via: "import ContributorDomainReputation"
      pattern: "ContributorDomainReputation"
---

<objective>
Close remaining tech debt items from the v1.0 milestone audit: remove normalize_tags dead code, add missing Alembic model imports, fix stale docstring, add Docker Compose API healthcheck, and document required environment variables in README.md and .env.example.

Purpose: Clean up accumulated tech debt across the API, Docker infrastructure, and documentation so the codebase is maintainable and deployment-ready.
Output: Cleaned tags.py, complete env.py imports, accurate traces.py docstring, Docker healthcheck on api service, README.md and .env.example with full configuration docs.
</objective>

<execution_context>
@/home/bitnami/.claude/get-shit-done/workflows/execute-plan.md
@/home/bitnami/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/v1.0-MILESTONE-AUDIT.md

@api/app/services/tags.py
@api/migrations/env.py
@api/app/routers/traces.py
@docker-compose.yml
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead code, fix imports, and fix stale docstring</name>
  <files>
    api/app/services/tags.py
    api/migrations/env.py
    api/app/routers/traces.py
  </files>
  <action>
1. In `api/app/services/tags.py`, remove the entire `normalize_tags` function (lines 14-26). Keep `normalize_tag` (singular) and `validate_tag`. The function is never imported or called anywhere in the codebase — it is dead code identified in the v1.0 audit. Do NOT remove `_VALID_TAG_PATTERN` or `validate_tag`.

2. In `api/migrations/env.py`, add two missing model imports after the existing model imports (after the Tag import line). Add:
```python
from app.models.amendment import Amendment  # noqa: F401
from app.models.reputation import ContributorDomainReputation  # noqa: F401
```
These models were added in Phase 2 (Amendment) and Phase 4 (ContributorDomainReputation) but were never added to env.py. Without them, `alembic check` and autogenerate would miss schema drift for those tables.

3. In `api/app/routers/traces.py`, fix the stale docstring in the `submit_trace` function. Change line 36 from:
```
    1. Authentication (CurrentUser dependency)
```
to:
```
    1. Authentication (RequireEmail dependency — email required for contributions)
```
The actual parameter type is `RequireEmail`, not `CurrentUser`. The docstring was written before Phase 4 changed the dependency.
  </action>
  <verify>
Run: `cd /home/bitnami/commontrace/api && python -c "from app.services.tags import normalize_tag, validate_tag; print('normalize_tag and validate_tag importable')"` — should succeed.
Run: `cd /home/bitnami/commontrace/api && python -c "from app.services.tags import normalize_tags" 2>&1` — should fail with ImportError (function removed).
Run: `grep -n 'Amendment\|ContributorDomainReputation' /home/bitnami/commontrace/api/migrations/env.py` — should show both imports.
Run: `grep 'RequireEmail' /home/bitnami/commontrace/api/app/routers/traces.py | head -3` — should show RequireEmail in the docstring.
Run: `grep 'CurrentUser dependency' /home/bitnami/commontrace/api/app/routers/traces.py` — should return no results (stale docstring removed).
  </verify>
  <done>normalize_tags function removed from tags.py; Amendment and ContributorDomainReputation imported in env.py; traces.py docstring says RequireEmail not CurrentUser</done>
</task>

<task type="auto">
  <name>Task 2: Add Docker Compose API healthcheck and upgrade mcp-server dependency</name>
  <files>docker-compose.yml</files>
  <action>
In `docker-compose.yml`, make two changes to improve startup reliability:

1. Add a healthcheck to the `api` service. The FastAPI app serves on port 8000. Use a simple curl to the root or a lightweight endpoint. Since we don't have a dedicated /health endpoint on the API, use a TCP check or curl to a known endpoint. The simplest approach: add a healthcheck that curls the OpenAPI docs endpoint which FastAPI serves by default:

```yaml
  api:
    build:
      context: ./api
    env_file:
      - .env
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8000/health\")'"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: >
      sh -c "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000"
```

Note: Use `python -c 'import urllib.request; urllib.request.urlopen(...)'` instead of `curl` because the API container is built from a Python base image and may not have curl installed. Python's urllib is always available.

2. Change the `mcp-server` service's dependency on `api` from `service_started` to `service_healthy`:

```yaml
  mcp-server:
    ...
    depends_on:
      api:
        condition: service_healthy
```

This ensures the MCP server does not start until the API is actually serving requests, rather than just having its process started.
  </action>
  <verify>
Run: `grep -A 6 'healthcheck' /home/bitnami/commontrace/docker-compose.yml` — should show the api healthcheck configuration.
Run: `grep -A 3 'depends_on' /home/bitnami/commontrace/docker-compose.yml | grep -A 1 'api:'` — should show `condition: service_healthy` for mcp-server's dependency on api.
Run: `cd /home/bitnami/commontrace && python -c "import yaml; d=yaml.safe_load(open('docker-compose.yml')); assert 'healthcheck' in d['services']['api']; assert d['services']['mcp-server']['depends_on']['api']['condition'] == 'service_healthy'; print('Docker Compose validated')"` — should print success. If PyYAML not installed, verify manually via grep.
  </verify>
  <done>API service has healthcheck; mcp-server depends on api with service_healthy condition</done>
</task>

<task type="auto">
  <name>Task 3: Document required environment variables in README.md and .env.example</name>
  <files>
    README.md
    .env.example
  </files>
  <action>
1. Update `.env.example` to add the two missing environment variables with clear comments explaining degraded behavior:

Add at the end of the existing file:

```
# --- Optional API keys (system runs in degraded mode without these) ---

# OpenAI API key for semantic search embeddings (text-embedding-3-small)
# Without this: search works in tag-only mode; semantic/hybrid search returns 503
# Get yours at: https://platform.openai.com/api-keys
# OPENAI_API_KEY=sk-...

# CommonTrace API key for MCP server stdio transport authentication
# Without this: MCP stdio transport has no default auth; HTTP transport uses client headers
# Generate one by calling POST /api/v1/keys after starting the API
# COMMONTRACE_API_KEY=
```

Note: Keys are commented out (prefixed with #) because they are secrets that must be explicitly set. This follows the convention of .env.example files — showing the variable name and format without providing a real value.

2. Create `README.md` at the project root. Keep it practical and concise — this is a developer-facing README for someone deploying CommonTrace, not marketing material. Include:

```markdown
# CommonTrace

A collective knowledge layer for AI coding agents. Agents search for solutions, contribute traces, vote on quality, and build domain-specific reputation — all through a three-tier architecture: FastAPI backend, MCP protocol adapter, and Claude Code skill.

## Quick Start

```bash
# Clone and configure
cp .env.example .env
# Edit .env to add your API keys (see Configuration below)

# Start all services
docker compose up --build
```

Services:
- **API** — http://localhost:8000 (FastAPI backend)
- **MCP Server** — http://localhost:8080 (Streamable HTTP transport)
- **PostgreSQL** — localhost:5432 (pgvector)
- **Redis** — localhost:6379 (rate limiting, caching)
- **Worker** — background embedding pipeline

## Configuration

### Required for full functionality

| Variable | Purpose | Without it |
|----------|---------|------------|
| `OPENAI_API_KEY` | Semantic search embeddings (text-embedding-3-small) | Search works in **tag-only mode**. Hybrid and semantic search return 503. Seed traces remain without embeddings. |
| `COMMONTRACE_API_KEY` | MCP server authentication (stdio transport) | MCP stdio transport has no default auth key. HTTP transport uses client-provided headers and is unaffected. |

### Always required (have defaults in docker-compose)

| Variable | Default | Purpose |
|----------|---------|---------|
| `DATABASE_URL` | `postgresql+asyncpg://commontrace:commontrace@localhost:5432/commontrace` | PostgreSQL connection |
| `REDIS_URL` | `redis://localhost:6379` | Redis connection |
| `VALIDATION_THRESHOLD` | `2` | Votes needed to promote a trace from pending to validated |
| `EMBEDDING_DIMENSIONS` | `1536` | Vector dimensions (matches text-embedding-3-small) |

### How to get API keys

**OPENAI_API_KEY:**
1. Create an account at https://platform.openai.com
2. Go to API keys: https://platform.openai.com/api-keys
3. Create a new key and add it to `.env`

**COMMONTRACE_API_KEY:**
1. Start the API: `docker compose up api`
2. Generate a key: `curl -X POST http://localhost:8000/api/v1/keys -H "Content-Type: application/json" -d '{"email": "your@email.com"}'`
3. Copy the returned key to `.env`

## Architecture

```
Claude Code Skill (/trace:search, /trace:contribute)
        |
    MCP Server (FastMCP, circuit breaker, dual transport)
        |
    FastAPI Backend (auth, PII scan, rate limiting, reputation)
        |
    PostgreSQL + pgvector (traces, embeddings, HNSW index)
    Redis (token-bucket rate limiter)
```

## Seed Data

Import 200+ curated traces for cold start:

```bash
docker compose exec api python -m fixtures.import_seeds
```

## Development

```bash
# Run API tests
cd api && python -m pytest

# Run migrations
cd api && alembic upgrade head
```

## License

See LICENSE file.
```

Ensure the README is a new file at the project root `/home/bitnami/commontrace/README.md`.
  </action>
  <verify>
Run: `test -f /home/bitnami/commontrace/README.md && echo "README exists"` — should print "README exists".
Run: `grep 'OPENAI_API_KEY' /home/bitnami/commontrace/README.md` — should show multiple mentions with degraded behavior explanation.
Run: `grep 'COMMONTRACE_API_KEY' /home/bitnami/commontrace/README.md` — should show mentions with explanation.
Run: `grep 'OPENAI_API_KEY' /home/bitnami/commontrace/.env.example` — should show the variable with comment about degraded behavior.
Run: `grep 'COMMONTRACE_API_KEY' /home/bitnami/commontrace/.env.example` — should show the variable with comment.
  </verify>
  <done>README.md exists at project root with configuration table documenting OPENAI_API_KEY and COMMONTRACE_API_KEY and their degraded behavior; .env.example includes both keys with explanatory comments</done>
</task>

</tasks>

<verification>
1. `normalize_tags` function does not exist in tags.py (only normalize_tag and validate_tag remain)
2. `api/migrations/env.py` imports Amendment and ContributorDomainReputation
3. `traces.py` docstring mentions RequireEmail, not CurrentUser
4. `docker-compose.yml` api service has healthcheck section
5. `docker-compose.yml` mcp-server depends on api with service_healthy
6. `README.md` exists and documents both OPENAI_API_KEY and COMMONTRACE_API_KEY with degraded behavior
7. `.env.example` includes both optional API keys with comments
</verification>

<success_criteria>
- Dead code removed (normalize_tags gone)
- Alembic env.py has complete model imports (6 model files: Trace, User, Vote, Tag, Amendment, ContributorDomainReputation)
- Stale docstring fixed
- Docker Compose startup is reliable (healthcheck + service_healthy)
- Environment configuration is fully documented
</success_criteria>

<output>
After completion, create `.planning/phases/08-tech-debt-cleanup/08-02-SUMMARY.md`
</output>
