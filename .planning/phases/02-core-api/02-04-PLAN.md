---
phase: 02-core-api
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - api/app/routers/moderation.py
  - api/app/main.py
autonomous: true

must_haves:
  truths:
    - "An agent can flag a trace as harmful or spam with a reason"
    - "A flagged trace has is_flagged=True and flagged_at timestamp set"
    - "Flagged traces are queryable via GET /api/v1/moderation/flagged"
    - "A flagged trace can be removed (soft-deleted or hard-deleted) by an authorized request"
  artifacts:
    - path: "api/app/routers/moderation.py"
      provides: "POST /api/v1/traces/{id}/flag, GET /api/v1/moderation/flagged, DELETE /api/v1/moderation/traces/{id}"
      contains: "flag_trace"
  key_links:
    - from: "api/app/routers/moderation.py"
      to: "api/app/models/trace.py"
      via: "UPDATE traces SET is_flagged=True, flagged_at=now()"
      pattern: "is_flagged"
    - from: "api/app/main.py"
      to: "api/app/routers/moderation.py"
      via: "include_router"
      pattern: "moderation"
---

<objective>
Add content moderation endpoints: flagging traces, listing flagged traces, and removing harmful content.

Purpose: Safety requirement SAFE-03 mandates that any agent can flag a trace and moderators can remove it. This completes the safety layer alongside PII scanning (SAFE-02) and staleness detection (SAFE-04, already integrated in trace submission).

Output: Moderation router with flag, list-flagged, and remove endpoints.
</objective>

<execution_context>
@/home/bitnami/.claude/get-shit-done/workflows/execute-plan.md
@/home/bitnami/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-api/02-RESEARCH.md
@.planning/phases/02-core-api/02-01-SUMMARY.md
@.planning/phases/02-core-api/02-02-SUMMARY.md

@api/app/dependencies.py
@api/app/main.py
@api/app/models/trace.py
@api/app/schemas/common.py
@api/app/middleware/rate_limiter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Moderation router with flag, list, and remove endpoints</name>
  <files>
    api/app/routers/moderation.py
  </files>
  <action>
1. Create api/app/routers/moderation.py:
   - APIRouter with prefix="/api/v1", tags=["moderation"]

   a. POST /traces/{trace_id}/flag endpoint:
      - Dependencies: CurrentUser, DbSession, WriteRateLimit
      - Accepts JSON body: `{"reason": str, "category": str}` where category is one of: "harmful", "spam", "incorrect", "duplicate"
      - Define a Pydantic model `FlagRequest(BaseModel)` inline or in schemas:
        - reason: str = Field(min_length=1, max_length=1000)
        - category: str (validated to be in approved set)
      - Verify trace exists: HTTPException(404) if not
      - If trace already flagged: return 200 with message "Trace already flagged" (idempotent)
      - UPDATE trace: is_flagged=True, flagged_at=func.now()
      - `await db.commit()`
      - Return 200 with {"trace_id": trace_id, "flagged": True, "category": category}

   b. GET /moderation/flagged endpoint:
      - Dependencies: CurrentUser, DbSession, ReadRateLimit
      - Query: `select(Trace).where(Trace.is_flagged == True).order_by(Trace.flagged_at.desc())`
      - Add optional query params: limit (int, default=50, max=100), offset (int, default=0)
      - Use selectinload(Trace.tags) to avoid MissingGreenlet
      - Return list of TraceResponse objects

   c. DELETE /moderation/traces/{trace_id} endpoint:
      - Dependencies: CurrentUser, DbSession, WriteRateLimit
      - Verify trace exists: HTTPException(404) if not
      - Hard delete: First delete related votes (cascade concern -- check FK constraints), then delete trace_tags entries, then delete the trace itself
      - Alternative if cascade is set up: `await db.delete(trace)`, `await db.commit()`
      - Since Phase 1 did NOT set up cascade deletes on foreign keys, manually delete:
        1. `DELETE FROM votes WHERE trace_id = :id`
        2. `DELETE FROM trace_tags WHERE trace_id = :id`
        3. `DELETE FROM amendments WHERE original_trace_id = :id` (from 02-01 migration)
        4. `DELETE FROM traces WHERE id = :id`
      - Use `await db.execute(delete(Vote).where(Vote.trace_id == trace_id))` etc.
      - `await db.commit()`
      - Return 200 with {"deleted": True, "trace_id": trace_id}
      - NOTE: In production this would be role-gated to moderators. For v1, any authenticated user can moderate (this is a known simplification documented in the response).
  </action>
  <verify>
    cd /home/bitnami/commontrace && python -c "
from app.routers.moderation import router as mod_router
routes = [(r.path, r.methods) for r in mod_router.routes if hasattr(r, 'methods')]
print(f'Moderation routes: {routes}')
# Expect: flag, list flagged, delete
assert any('/flag' in r[0] for r in routes), 'Missing flag endpoint'
assert any('/flagged' in r[0] for r in routes), 'Missing list flagged endpoint'
assert any('DELETE' in str(r[1]) for r in routes), 'Missing delete endpoint'
print('All moderation routes present')
"
  </verify>
  <done>
    - POST /traces/{id}/flag marks trace as flagged with reason and category
    - GET /moderation/flagged lists all flagged traces with pagination
    - DELETE /moderation/traces/{id} hard-deletes trace and related records
    - All endpoints require authentication and rate limiting
  </done>
</task>

<task type="auto">
  <name>Task 2: Register moderation router and final endpoint verification</name>
  <files>
    api/app/main.py
  </files>
  <action>
1. Update api/app/main.py to include the moderation router:
   - Import: `from app.routers import moderation`
   - Add: `app.include_router(moderation.router)`
   - This is the ONLY change to main.py -- keep all existing routers from Plan 02-03

2. Final verification: run a comprehensive route listing to confirm ALL Phase 2 endpoints are registered:
   - POST /api/v1/keys (auth -- no auth required)
   - GET /api/v1/keys/verify (auth check)
   - POST /api/v1/traces (submit trace)
   - GET /api/v1/traces/{trace_id} (get trace)
   - POST /api/v1/traces/{trace_id}/votes (cast vote)
   - POST /api/v1/traces/{trace_id}/amendments (submit amendment)
   - POST /api/v1/traces/{trace_id}/flag (flag trace)
   - GET /api/v1/moderation/flagged (list flagged)
   - DELETE /api/v1/moderation/traces/{trace_id} (remove trace)
   - GET /health (health check -- from Phase 1)
  </action>
  <verify>
    cd /home/bitnami/commontrace && python -c "
from app.main import app

# Comprehensive route listing
all_routes = []
for route in app.routes:
    if hasattr(route, 'methods') and hasattr(route, 'path'):
        for method in route.methods:
            if method not in ('HEAD', 'OPTIONS'):
                all_routes.append(f'{method} {route.path}')
all_routes.sort()
print('=== ALL PHASE 2 ENDPOINTS ===')
for r in all_routes:
    print(f'  {r}')
print(f'Total: {len(all_routes)} endpoints')

# Verify count: expect 10 (9 Phase 2 + 1 health)
assert len(all_routes) >= 9, f'Expected at least 9 endpoints, got {len(all_routes)}'
print('Endpoint count OK')
"
  </verify>
  <done>
    - Moderation router registered on FastAPI app
    - All 10 endpoints (9 Phase 2 + health check) visible in route listing
    - OpenAPI schema (/docs) shows all endpoints with proper tags
  </done>
</task>

</tasks>

<verification>
1. All moderation endpoints registered and importable
2. Flag endpoint is idempotent (flagging twice returns 200 both times)
3. Delete endpoint handles cascading record removal
4. Total endpoint count >= 10 (9 Phase 2 + 1 health)
</verification>

<success_criteria>
- Any authenticated agent can flag a trace as harmful or spam (SAFE-03)
- Flagged traces are queryable by a moderator (SAFE-03)
- Flagged traces can be removed (SAFE-03)
- All Phase 2 endpoints are registered and accessible
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-api/02-04-SUMMARY.md`
</output>
