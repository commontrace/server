---
phase: 06-claude-code-skill
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skill/.claude-plugin/plugin.json
  - skill/.mcp.json
  - skill/commands/trace/search.md
  - skill/commands/trace/contribute.md
  - skill/skills/commontrace/SKILL.md
autonomous: true

must_haves:
  truths:
    - "A Claude Code agent with the plugin installed sees /trace:search and /trace:contribute as available slash commands"
    - "Installing the plugin automatically configures the CommonTrace MCP server — no manual claude mcp add required"
    - "/trace:search [query] calls the search_traces MCP tool and presents formatted results"
    - "/trace:contribute walks the agent through a multi-step contribution flow with preview and explicit confirmation before submission"
  artifacts:
    - path: "skill/.claude-plugin/plugin.json"
      provides: "Plugin manifest with name commontrace"
      contains: '"name": "commontrace"'
    - path: "skill/.mcp.json"
      provides: "MCP server auto-configuration for HTTP transport"
      contains: "COMMONTRACE_MCP_URL"
    - path: "skill/commands/trace/search.md"
      provides: "/trace:search slash command"
      contains: "mcp__plugin_commontrace_commontrace__search_traces"
    - path: "skill/commands/trace/contribute.md"
      provides: "/trace:contribute slash command"
      contains: "mcp__plugin_commontrace_commontrace__contribute_trace"
    - path: "skill/skills/commontrace/SKILL.md"
      provides: "Autonomous skill context guiding Claude when to use CommonTrace"
      contains: "Search before writing code"
  key_links:
    - from: "skill/.mcp.json"
      to: "mcp-server/app/server.py"
      via: "HTTP transport URL pointing to MCP server"
      pattern: "localhost:8080"
    - from: "skill/commands/trace/search.md"
      to: "skill/.mcp.json"
      via: "MCP tool name prefix derived from plugin name + server key"
      pattern: "mcp__plugin_commontrace_commontrace__"
    - from: "skill/commands/trace/contribute.md"
      to: "skill/.mcp.json"
      via: "MCP tool name prefix derived from plugin name + server key"
      pattern: "mcp__plugin_commontrace_commontrace__"
---

<objective>
Create the Claude Code plugin shell with MCP auto-configuration and explicit slash commands.

Purpose: Satisfy SKIL-01 (explicit /trace:search and /trace:contribute commands) and SKIL-02 (auto-configure MCP on install). This plan creates the plugin structure that all subsequent skill work builds on.

Output: A complete Claude Code plugin at `skill/` with plugin manifest, MCP auto-configuration, two slash commands, and a SKILL.md for autonomous context guidance.
</objective>

<execution_context>
@/home/bitnami/.claude/get-shit-done/workflows/execute-plan.md
@/home/bitnami/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-claude-code-skill/06-RESEARCH.md
@.planning/phases/05-mcp-server/05-01-SUMMARY.md

## Key Facts From Research

- Plugin name in plugin.json MUST be "commontrace" (no hyphens) — tool names derive from this
- MCP server key in .mcp.json MUST also be "commontrace" — consistent with plugin name
- Full MCP tool name pattern: `mcp__plugin_commontrace_commontrace__<tool_name>`
- Five tools exist: search_traces, contribute_trace, vote_trace, get_trace, list_tags
- MCP server runs on port 8080 via HTTP transport (docker-compose.yml from Phase 5)
- Commands use `allowed-tools` frontmatter to pre-allow MCP tools (avoids permission prompts)
- `$ARGUMENTS` in command body expands to user's slash command arguments
- `${COMMONTRACE_MCP_URL:-http://localhost:8080/mcp}` uses shell default expansion for local dev
- `${COMMONTRACE_API_KEY}` must be set in user's environment — no safe default possible

## Existing Files

- `skill/pyproject.toml` already exists (empty deps, keep it)
- `mcp-server/app/server.py` has all 5 tools defined with circuit breaker protection
- MCP server FastMCP name is "CommonTrace" (capital C, capital T)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plugin manifest and MCP auto-configuration</name>
  <files>
    skill/.claude-plugin/plugin.json
    skill/.mcp.json
  </files>
  <action>
Create the plugin manifest and MCP server configuration:

**skill/.claude-plugin/plugin.json:**
```json
{
  "name": "commontrace",
  "description": "CommonTrace knowledge base integration for Claude Code agents. Auto-searches for relevant traces at session start, provides /trace:search and /trace:contribute commands.",
  "author": {
    "name": "CommonTrace",
    "email": "support@commontrace.dev"
  }
}
```

**skill/.mcp.json:**
```json
{
  "commontrace": {
    "type": "http",
    "url": "${COMMONTRACE_MCP_URL:-http://localhost:8080/mcp}",
    "headers": {
      "X-API-Key": "${COMMONTRACE_API_KEY}"
    }
  }
}
```

Key constraints:
- Plugin name MUST be "commontrace" (lowercase, no hyphens) — this determines the MCP tool prefix
- .mcp.json server key MUST also be "commontrace" — consistency with plugin name for tool naming
- The default MCP URL (`http://localhost:8080/mcp`) matches the docker-compose MCP server port from Phase 5
- `${COMMONTRACE_API_KEY}` has no default — it must be set in the user's environment
  </action>
  <verify>
Verify files exist and contain correct content:
```bash
cat skill/.claude-plugin/plugin.json | python3 -m json.tool
cat skill/.mcp.json | python3 -m json.tool
# Verify plugin name is "commontrace" in both files
grep -q '"name": "commontrace"' skill/.claude-plugin/plugin.json
grep -q '"commontrace"' skill/.mcp.json
```
  </verify>
  <done>plugin.json exists with name "commontrace", .mcp.json exists with server key "commontrace" pointing to ${COMMONTRACE_MCP_URL:-http://localhost:8080/mcp} with X-API-Key header</done>
</task>

<task type="auto">
  <name>Task 2: Slash commands and SKILL.md</name>
  <files>
    skill/commands/trace/search.md
    skill/commands/trace/contribute.md
    skill/skills/commontrace/SKILL.md
  </files>
  <action>
Create the two slash commands and the SKILL.md:

**skill/commands/trace/search.md:**
```markdown
---
description: Search CommonTrace knowledge base for coding traces
argument-hint: [query]
allowed-tools: ["mcp__plugin_commontrace_commontrace__search_traces"]
---

Search CommonTrace for traces matching: "$ARGUMENTS"

Use mcp__plugin_commontrace_commontrace__search_traces with:
- query: "$ARGUMENTS"
- limit: 5

Present each result clearly with:
- Title
- Context summary (2 sentences max)
- Solution summary (2 sentences max)
- Tags
- Trace ID (for reference)

If no results are found, say so clearly.
If CommonTrace is unavailable, say so and continue normally — do not retry or block.
```

**skill/commands/trace/contribute.md:**
```markdown
---
description: Contribute a trace to CommonTrace knowledge base
allowed-tools: ["mcp__plugin_commontrace_commontrace__contribute_trace", "mcp__plugin_commontrace_commontrace__list_tags"]
---

Guide the user through contributing a trace to CommonTrace.

Follow these steps in order:

Step 1: Ask what problem was solved. This becomes the context_text.
Step 2: Ask what the solution was. This becomes the solution_text.
Step 3: Ask for a short descriptive title (under 100 characters).
Step 4: Use mcp__plugin_commontrace_commontrace__list_tags to show available tags. Ask the user to select applicable tags or suggest new ones.
Step 5: Show a complete preview of the trace:
  - Title
  - Context
  - Solution
  - Tags

  Ask for explicit confirmation: "Submit this trace to CommonTrace? (yes/no)"

Step 6: ONLY after the user confirms with "yes", use mcp__plugin_commontrace_commontrace__contribute_trace to submit with the title, context_text, solution_text, and tags.
Step 7: Report the trace ID from the result.

CRITICAL: Never submit a trace without explicit user confirmation. Always show the preview first.
If the user says "no" or wants changes, loop back to the relevant step.
If CommonTrace is unavailable, inform the user and suggest trying again later.
```

**skill/skills/commontrace/SKILL.md:**
```markdown
---
name: commontrace
description: >
  Use this skill when the agent is about to solve a coding problem, implement a feature,
  debug an error, or configure a tool. It provides access to the CommonTrace knowledge base —
  a collective memory of coding solutions contributed by other AI agents. Search before writing
  code. Contribute after solving.
version: 0.1.0
---

# CommonTrace: Shared Knowledge Base for Coding Agents

## When to Use

**Before starting work:** Search CommonTrace for relevant traces when you detect:
- A coding task involving a specific framework, library, or API
- An error message or debugging scenario
- A configuration or setup challenge
- A pattern that other agents have likely encountered before

**After completing work:** Offer to contribute when you:
- Solved a non-trivial problem that others might face
- Discovered a workaround for a known issue
- Found an undocumented pattern or configuration

## Available MCP Tools

- **search_traces**: Search by natural language query and/or structured tags
- **contribute_trace**: Submit a new trace (context + solution pair)
- **vote_trace**: Upvote or downvote traces you've used (with feedback)
- **get_trace**: Read a specific trace by ID
- **list_tags**: Discover available filter tags

## Slash Commands

- `/trace:search [query]` — Explicit search with formatted results
- `/trace:contribute` — Guided contribution flow with preview and confirmation

## Guidelines

1. **Search silently, present concisely**: When searching proactively, only mention results if they are directly relevant. Do not announce "I searched CommonTrace and found nothing."
2. **Never contribute without confirmation**: Always preview the trace and get explicit user approval before submitting.
3. **Tag accurately**: Use existing tags from list_tags when possible. Suggest new tags only when no existing tag fits.
4. **Fail gracefully**: If CommonTrace is unavailable, continue the task normally. Never block work waiting for CommonTrace.
```

Key constraints:
- The `allowed-tools` array in command frontmatter MUST use the exact tool name format: `mcp__plugin_commontrace_commontrace__<tool_name>`
- The `/trace:contribute` command MUST include list_tags in allowed-tools (used in step 4)
- The contribute command MUST enforce preview-then-confirm flow (SKIL-04 requirement: "no trace is submitted without explicit confirmation")
- SKILL.md description field is what Claude uses to decide when to activate the skill — make it detailed about coding contexts
  </action>
  <verify>
Verify all three files exist and have correct structure:
```bash
# Check files exist
ls -la skill/commands/trace/search.md skill/commands/trace/contribute.md skill/skills/commontrace/SKILL.md

# Check allowed-tools reference correct MCP tool names
grep "mcp__plugin_commontrace_commontrace__search_traces" skill/commands/trace/search.md
grep "mcp__plugin_commontrace_commontrace__contribute_trace" skill/commands/trace/contribute.md
grep "mcp__plugin_commontrace_commontrace__list_tags" skill/commands/trace/contribute.md

# Check SKILL.md has frontmatter
head -5 skill/skills/commontrace/SKILL.md
```
  </verify>
  <done>/trace:search command exists with search_traces in allowed-tools, /trace:contribute command exists with contribute_trace and list_tags in allowed-tools and enforces preview-confirm flow, SKILL.md exists with name "commontrace" and descriptive triggers for coding contexts</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Plugin structure matches research-recommended layout:
   ```
   skill/
   ├── .claude-plugin/
   │   └── plugin.json
   ├── .mcp.json
   ├── commands/
   │   └── trace/
   │       ├── search.md
   │       └── contribute.md
   ├── skills/
   │   └── commontrace/
   │       └── SKILL.md
   └── pyproject.toml  (already exists)
   ```
2. `plugin.json` name matches `.mcp.json` server key (both "commontrace")
3. All `allowed-tools` entries use pattern `mcp__plugin_commontrace_commontrace__*`
4. The MCP URL default points to localhost:8080 (Phase 5 MCP server port)
5. The contribute command enforces explicit confirmation before submission
</verification>

<success_criteria>
- Plugin manifest, MCP config, two commands, and SKILL.md exist at correct paths
- Plugin name and MCP server key are both "commontrace" (no mismatch)
- /trace:search pre-allows search_traces tool
- /trace:contribute pre-allows contribute_trace and list_tags tools
- /trace:contribute enforces preview-confirm flow (never submits without "yes")
- SKILL.md provides autonomous guidance for search-before-code and contribute-after-solve
</success_criteria>

<output>
After completion, create `.planning/phases/06-claude-code-skill/06-01-SUMMARY.md`
</output>
