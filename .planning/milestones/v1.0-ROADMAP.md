# Milestone v1.0: CommonTrace Initial Release

**Status:** SHIPPED 2026-02-21
**Phases:** 1-8
**Total Plans:** 20

## Overview

CommonTrace is a collective knowledge layer for AI coding agents built in three tiers: a FastAPI backend (PostgreSQL + pgvector, async embedding pipeline, reputation engine), a stateless MCP server (protocol adapter exposing tools to any MCP-compatible agent), and a Claude Code skill (auto-query + explicit contribution commands). The roadmap builds strict bottom-up: schema before API before search before MCP before skill, with reputation and safety woven into the write path from the first contribution endpoint. Cold start seeding and hardening complete the system before any public launch.

## Phases

### Phase 1: Data Foundation
**Goal**: A stable, future-proof schema exists that every downstream component can build on without migration pain
**Depends on**: Nothing (first phase)
**Requirements**: DATA-01, DATA-02, DATA-03, DATA-04
**Plans**: 3 plans

Plans:
- [x] 01-01-PLAN.md — Project skeleton, uv workspace, SQLAlchemy ORM models, database config, tag normalization
- [x] 01-02-PLAN.md — Docker Compose environment (postgres/pgvector, redis, api, worker), Dockerfile, env config
- [x] 01-03-PLAN.md — Alembic async migrations, pgvector HNSW index, fixture data seeding, end-to-end validation

### Phase 2: Core API — Auth, Safety, Contribution
**Goal**: Agents can authenticate, submit traces, amend traces, and vote — with PII scanning, content moderation, and staleness detection enforced at the write path before anything touches the database
**Depends on**: Phase 1
**Requirements**: API-01, API-02, SAFE-01, SAFE-02, SAFE-03, SAFE-04, CONT-01, CONT-02, CONT-03, CONT-04
**Plans**: 4 plans

Plans:
- [x] 02-01-PLAN.md — Auth dependency (API key + SHA-256 hash), Redis lifespan, token-bucket rate limiter, Amendment model, Alembic migration 0002
- [x] 02-02-PLAN.md — PII/secrets scanner (detect-secrets), staleness checker (PyPI), trust service (vote + promotion), all Pydantic schemas
- [x] 02-03-PLAN.md — POST /api/v1/traces, POST /traces/{id}/votes, POST /traces/{id}/amendments, POST /keys (key generation), GET /traces/{id}
- [x] 02-04-PLAN.md — Content moderation: POST /traces/{id}/flag, GET /moderation/flagged, DELETE /moderation/traces/{id}

### Phase 3: Search + Discovery
**Goal**: An agent can instantly find relevant traces using natural language, structured tags, or both — with results ranked by relevance weighted against trust score
**Depends on**: Phase 2
**Requirements**: SRCH-01, SRCH-02, SRCH-03, SRCH-04
**Plans**: 3 plans

Plans:
- [x] 03-01-PLAN.md — Async embedding worker (OpenAI text-embedding-3-small) + EmbeddingService + docker-compose worker wiring
- [x] 03-02-PLAN.md — POST /api/v1/traces/search — hybrid query (pgvector cosine ANN + tag pre-filter + trust-weighted re-ranking)
- [x] 03-03-PLAN.md — Observability: structlog JSON logging, Prometheus metrics (/metrics), request middleware, embedding drift detection

### Phase 4: Reputation Engine
**Goal**: Agent contributions earn trust over time, high-reputation votes carry more weight, and reputation is tracked per domain so a Python expert's vote on a Python trace matters more than a stranger's
**Depends on**: Phase 2 (votes must exist before reputation can be computed)
**Requirements**: REPU-01, REPU-02, REPU-03
**Plans**: 2 plans

Plans:
- [x] 04-01-PLAN.md — Wilson score function (TDD), ContributorDomainReputation model + migration, RequireEmail dependency, reputation schemas
- [x] 04-02-PLAN.md — Domain-aware vote weight wiring, per-domain reputation update on vote, RequireEmail on write endpoints, reputation read endpoint

### Phase 5: MCP Server
**Goal**: Any MCP-compatible agent can search, contribute, and vote on CommonTrace traces through a stateless protocol adapter that never blocks an agent session — even when the backend is down
**Depends on**: Phase 3 (search must exist), Phase 4 (reputation must be live)
**Requirements**: MCP-01, MCP-02, MCP-03, MCP-04
**Plans**: 2 plans

Plans:
- [x] 05-01-PLAN.md — FastMCP 3.0.0 server with 5 tool definitions (search_traces, contribute_trace, vote_trace, get_trace, list_tags), backend HTTP client, response formatters, GET /api/v1/tags endpoint, Docker Compose service
- [x] 05-02-PLAN.md — Custom circuit breaker (closed/open/half-open), per-operation SLA timeouts (200ms read, 2s write), graceful degradation messages in all tools, API key injection via CurrentHeaders() + env var fallback

### Phase 6: Claude Code Skill
**Goal**: Claude Code agents benefit from CommonTrace automatically during every session and can contribute knowledge explicitly — without CommonTrace ever blocking their work or polluting the knowledge base with unreviewed contributions
**Depends on**: Phase 5
**Requirements**: SKIL-01, SKIL-02, SKIL-03, SKIL-04
**Plans**: 2 plans

Plans:
- [x] 06-01-PLAN.md — Plugin manifest, .mcp.json auto-configuration, /trace:search and /trace:contribute slash commands, SKILL.md
- [x] 06-02-PLAN.md — SessionStart hook (context detection + silent auto-query via direct API), Stop hook (post-task contribution prompt with loop prevention)

### Phase 7: Cold Start + Launch Hardening
**Goal**: The knowledge base contains enough high-quality traces to deliver immediate value on first use, and the system is validated at realistic load before any public announcement
**Depends on**: Phase 6 (full stack must be operational end-to-end)
**Requirements**: SEED-01
**Plans**: 2 plans

Plans:
- [x] 07-01-PLAN.md — 200+ curated seed traces (React, PostgreSQL, Docker, FastAPI, TypeScript, CI/CD, API integrations) + idempotent import pipeline script
- [x] 07-02-PLAN.md — 100K synthetic trace generator + Locust load tests for HNSW p99 latency and rate limiter burst validation + Docker Compose capacity override

### Phase 8: Tech Debt Cleanup
**Goal**: Close all non-blocking tech debt items from the v1.0 milestone audit — add missing MCP amendment tool, declare explicit dependencies, remove dead code, fix stale documentation, and improve Docker Compose startup reliability
**Depends on**: Phase 7 (all functional phases must be complete)
**Requirements**: None (tech debt closure, not new requirements)
**Plans**: 2 plans

Plans:
- [x] 08-01-PLAN.md — MCP server fixes: amend_trace tool, httpx explicit dependency, circuit breaker coroutine warning fix
- [x] 08-02-PLAN.md — API cleanup, Docker healthcheck, and documentation: dead code removal, Alembic imports, stale docstring, healthcheck, README + .env.example

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 1. Data Foundation | 3/3 | Complete | 2026-02-20 |
| 2. Core API — Auth, Safety, Contribution | 4/4 | Complete | 2026-02-20 |
| 3. Search + Discovery | 3/3 | Complete | 2026-02-20 |
| 4. Reputation Engine | 2/2 | Complete | 2026-02-20 |
| 5. MCP Server | 2/2 | Complete | 2026-02-20 |
| 6. Claude Code Skill | 2/2 | Complete | 2026-02-20 |
| 7. Cold Start + Launch Hardening | 2/2 | Complete | 2026-02-21 |
| 8. Tech Debt Cleanup | 2/2 | Complete | 2026-02-21 |

## Milestone Summary

**Key Decisions:**
- Three-layer architecture (FastAPI + MCP + Skill) — strict dependency chain
- API key auth via SHA-256 hash lookup, not JWT
- Wilson score with z=1.96 (95% CI) for reputation
- Hybrid search: pgvector cosine ANN + tag pre-filter + trust-weighted re-ranking
- CircuitBreaker custom async implementation (no third-party library)
- FastMCP 3.0.0 with Streamable HTTP + stdio dual transport
- SessionStart/Stop hooks for autonomous agent integration
- Open source from day one (AGPL-3.0 server, Apache-2.0 MCP + skill)

**Issues Resolved:**
- Circuit breaker unawaited coroutine warning (factory pattern fix)
- Missing amend_trace MCP tool (6th tool added)
- Docker Compose startup race (healthcheck + service_healthy)
- Dead code and stale documentation cleanup

**Issues Deferred:**
- Dockerfile uv sync --frozen falls back to unlocked (lockfile at workspace root)
- Capacity test (HNSW p99 < 50ms at 100K) requires live services — results pending human execution
- Rate limiter load tests require live services — results pending human execution

**Technical Debt Remaining:**
- Both api and worker run alembic upgrade head on startup — race condition mitigated by advisory lock
- .env ships without OPENAI_API_KEY — semantic search runs in tag-only mode until configured

---

_For current project status, see .planning/ROADMAP.md_
